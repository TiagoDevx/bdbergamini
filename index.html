<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamentos de Imagens</title>
    <!-- CSS remains the same as in your original code -->
    <style>
        /* Your existing CSS styles remain unchanged */
    </style>
</head>
<body>
    <!-- HTML structure remains mostly the same -->
    <div class="login-container">
        <div class="login-box">
            <h2>Login</h2>
            <input type="text" id="username" placeholder="Usuário">
            <input type="password" id="password" placeholder="Senha">
            <button id="login-button">Entrar</button>
        </div>
    </div>

    <div class="container" style="display: none;">
        <div class="header">
            <h1>Gerenciamento de Imagens</h1>
            <div class="clock" id="clock">Carregando...</div>
        </div>

        <div class="section">
            <h2>Vincular Agora</h2>
            <div class="upload-area" id="upload-area">
                <p>Arraste e solte suas imagens aqui ou</p>
                <label for="fileElem">Selecione arquivos</label>
                <input type="file" id="fileElem" multiple accept="image/*">
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="image-preview" id="image-preview"></div>
            <div class="action-buttons">
                <button onclick="uploadImages()">Vincular Agora</button>
                <button onclick="showScheduledSection()">Agendar Post</button>
            </div>
        </div>

        <div class="action-buttons">
            <button class="history" onclick="showHistory()">Histórico</button>
            <button class="delete-all" onclick="deleteAllImages()">Apagar Todas as Imagens</button>
        </div>

        <div class="scheduled-section" id="scheduled-section" style="display: none;">
            <h3>Agendar Post</h3>
            <div class="upload-area" id="scheduled-upload-area">
                <p>Arraste e solte suas imagens aqui ou</p>
                <label for="scheduled-fileElem">Selecione arquivos</label>
                <input type="file" id="scheduled-fileElem" multiple accept="image/*">
            </div>
            <div class="image-preview" id="scheduled-image-preview"></div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="scheduled-progress-bar"></div>
            </div>
            <div class="schedule-form">
                <label>Data de Início:</label>
                <input type="date" id="start-date">
                <input type="time" id="start-time">
                <label>Data de Término:</label>
                <input type="date" id="end-date">
                <input type="time" id="end-time">
                <button onclick="scheduleImages()">Confirmar Agendamento</button>
            </div>
            <div class="scheduled-list" id="scheduled-list"></div>
        </div>

        <div class="history-section" id="history-section" style="display: none;">
            <h3>Histórico</h3>
            <div class="history-list" id="history-list"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAPcnUH5oj0krqEBcKFkRxg6h7GWiOiGWs",
            authDomain: "bc-berga.firebaseapp.com",
            projectId: "bc-berga",
            storageBucket: "bc-berga.firebasestorage.app",
            messagingSenderId: "955771763943",
            appId: "1:955771763943:web:b8e2b3c96dc7c8ddaaf642",
            measurementId: "G-1234T7JC84"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const database = firebase.database();

        // Constants
        const USERNAME = "MarketingBergamini";
        const PASSWORD = "MarketingLoja010401@";
        let currentNumber = 1;

        // Login Function
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (username === USERNAME && password === PASSWORD) {
                document.querySelector('.login-container').style.display = 'none';
                document.querySelector('.container').style.display = 'block';
                startClock();
                startScheduledImageCheck();
            } else {
                alert('Usuário ou senha incorretos!');
            }
        }

        // Clock Function
        function startClock() {
            const clockElement = document.getElementById('clock');
            setInterval(() => {
                clockElement.textContent = `Relógio: ${new Date().toLocaleString()}`;
            }, 1000);
        }

        // Event Listeners
        document.getElementById('login-button').addEventListener('click', login);
        document.getElementById('fileElem').addEventListener('change', () => previewImages('fileElem', 'image-preview'));
        document.getElementById('scheduled-fileElem').addEventListener('change', () => previewImages('scheduled-fileElem', 'scheduled-image-preview'));

        // Preview Images
        function previewImages(inputId, previewId) {
            const files = document.getElementById(inputId).files;
            const preview = document.getElementById(previewId);
            preview.innerHTML = '';

            for (const file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        }

        // Upload Images Immediately
        async function uploadImages() {
            const files = document.getElementById('fileElem').files;
            if (!files.length) return alert('Selecione pelo menos uma imagem.');

            const progressBar = document.getElementById('progress-bar');
            let completed = 0;

            for (const file of files) {
                const fileName = `${currentNumber++}.jpg`;
                const storageRef = storage.ref(`images/${fileName}`);
                const uploadTask = storageRef.put(file);

                await new Promise((resolve) => {
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            progressBar.style.width = `${(snapshot.bytesTransferred / snapshot.totalBytes) * 100}%`;
                        },
                        (error) => {
                            console.error('Upload error:', error);
                            alert('Erro ao vincular imagem.');
                        },
                        async () => {
                            const url = await uploadTask.snapshot.ref.getDownloadURL();
                            await addToHistory('Imagem vinculada', fileName);
                            completed++;
                            if (completed === files.length) {
                                progressBar.style.width = '0%';
                                alert('Imagens vinculadas com sucesso!');
                            }
                            resolve();
                        }
                    );
                });
            }
        }

        // Show Scheduling Section
        function showScheduledSection() {
            document.getElementById('scheduled-section').style.display = 'block';
            loadScheduledImages();
        }

        // Schedule Images
        async function scheduleImages() {
            const files = document.getElementById('scheduled-fileElem').files;
            if (!files.length) return alert('Selecione pelo menos uma imagem.');

            const startDate = document.getElementById('start-date').value;
            const startTime = document.getElementById('start-time').value;
            const endDate = document.getElementById('end-date').value;
            const endTime = document.getElementById('end-time').value;

            if (!startDate || !startTime || !endDate || !endTime) {
                return alert('Preencha todos os campos de data e hora.');
            }

            const start = new Date(`${startDate}T${startTime}`);
            const end = new Date(`${endDate}T${endTime}`);
            if (start >= end) return alert('Data de início deve ser anterior à data de término.');

            const progressBar = document.getElementById('scheduled-progress-bar');
            let completed = 0;

            for (const file of files) {
                const reader = new FileReader();
                await new Promise((resolve) => {
                    reader.onload = async (e) => {
                        const base64 = e.target.result.split(',')[1];
                        const fileName = file.name;
                        const scheduleRef = database.ref('scheduledImages').push();

                        await scheduleRef.set({
                            originalName: fileName,
                            base64: base64,
                            startTime: start.toISOString(),
                            endTime: end.toISOString(),
                            status: 'pending',
                            numericName: null
                        });

                        completed++;
                        progressBar.style.width = `${(completed / files.length) * 100}%`;
                        if (completed === files.length) {
                            progressBar.style.width = '0%';
                            alert('Imagens agendadas com sucesso!');
                            loadScheduledImages();
                        }
                        resolve();
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        // Load Scheduled Images
        function loadScheduledImages() {
            const scheduledList = document.getElementById('scheduled-list');
            if (!scheduledList) return;

            scheduledList.innerHTML = '';
            database.ref('scheduledImages').once('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                Object.entries(data).forEach(([key, { originalName, startTime, endTime, base64, status }]) => {
                    const item = document.createElement('div');
                    item.className = 'scheduled-item';
                    item.innerHTML = `
                        <img src="data:image/jpeg;base64,${base64}" alt="${originalName}">
                        <div class="info">
                            <div>${originalName} (${status})</div>
                            <div class="period">${new Date(startTime).toLocaleString()} - ${new Date(endTime).toLocaleString()}</div>
                        </div>
                        <button class="delete-btn" onclick="deleteScheduled('${key}')">Excluir</button>
                    `;
                    scheduledList.appendChild(item);
                });
            });
        }

        // Delete Scheduled Image
        function deleteScheduled(key) {
            database.ref(`scheduledImages/${key}`).remove()
                .then(() => {
                    loadScheduledImages();
                    alert('Agendamento excluído com sucesso!');
                })
                .catch(error => console.error('Error deleting scheduled image:', error));
        }

        // Check and Process Scheduled Images
        function checkScheduledImages() {
            const now = new Date();
            database.ref('scheduledImages').once('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                Object.entries(data).forEach(async ([key, schedule]) => {
                    const { base64, startTime, endTime, status, numericName } = schedule;
                    const start = new Date(startTime);
                    const end = new Date(endTime);

                    if (status === 'pending' && now >= start && now < end) {
                        const newName = `${currentNumber++}.jpg`;
                        const storageRef = storage.ref(`images/${newName}`);

                        try {
                            await storageRef.putString(base64, 'base64');
                            await database.ref(`scheduledImages/${key}`).update({
                                status: 'active',
                                numericName: newName
                            });
                            await addToHistory('Imagem agendada ativada', newName);
                        } catch (error) {
                            console.error('Error activating scheduled image:', error);
                        }
                    } else if (status === 'active' && now >= end && numericName) {
                        try {
                            await storage.ref(`images/${numericName}`).delete();
                            await database.ref(`scheduledImages/${key}`).update({
                                status: 'expired',
                                numericName: null
                            });
                            await addToHistory('Imagem agendada expirada', numericName);
                        } catch (error) {
                            console.error('Error expiring scheduled image:', error);
                        }
                    }
                });
            });
        }

        // Start Scheduled Image Check
        function startScheduledImageCheck() {
            checkScheduledImages(); // Check immediately
            setInterval(checkScheduledImages, 30000); // Check every 30 seconds
        }

        // History Functions
        async function showHistory() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            const snapshot = await database.ref('history').once('value');
            const history = snapshot.val();

            if (history) {
                Object.entries(history).forEach(([key, { action, imageName, timestamp }]) => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <div class="info">
                            <div>${action}: ${imageName}</div>
                            <div>${new Date(timestamp).toLocaleString()}</div>
                        </div>
                        <button class="delete-btn" onclick="deleteHistory('${key}')">Excluir</button>
                    `;
                    historyList.appendChild(item);
                });
            }
            document.getElementById('history-section').style.display = 'block';
        }

        async function addToHistory(action, imageName) {
            await database.ref('history').push().set({
                action,
                imageName,
                timestamp: Date.now()
            });
        }

        function deleteHistory(key) {
            database.ref(`history/${key}`).remove()
                .then(() => showHistory())
                .catch(error => console.error('Error deleting history:', error));
        }

        // Delete All Images
        async function deleteAllImages() {
            if (!confirm('Tem certeza que deseja apagar tudo?')) return;

            try {
                const list = await storage.ref('images').listAll();
                await Promise.all(list.items.map(item => item.delete()));
                await database.ref('scheduledImages').remove();
                await database.ref('history').remove();
                
                document.getElementById('image-preview').innerHTML = '';
                document.getElementById('scheduled-image-preview').innerHTML = '';
                document.getElementById('scheduled-list').innerHTML = '';
                document.getElementById('history-list').innerHTML = '';
                alert('Tudo foi removido com sucesso!');
            } catch (error) {
                console.error('Error deleting all:', error);
                alert('Erro ao remover tudo.');
            }
        }
    </script>
</body>
</html>
