<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Imagens</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            padding: 20px;
        }
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #ff7f50;
        }
        .login-box {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            width: 350px;
            text-align: center;
        }
        .login-box h2 {
            margin-bottom: 20px;
            color: #ff7f50;
        }
        .login-box input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .login-box button {
            width: 100%;
            padding: 10px;
            background-color: #ff7f50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
        }
        .image-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        .image-item {
            position: relative;
            width: 80px;
            height: 80px;
            border: 1px solid #ff7f50;
            border-radius: 8px;
            overflow: hidden;
        }
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-item .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff6347;
            color: white;
            border: none;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        .clock {
            font-size: 24px;
            font-weight: bold;
            color: #ff7f50;
            text-align: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<div class="login-container">
    <div class="login-box">
        <h2>Login</h2>
        <input type="text" id="username" placeholder="Usuário">
        <input type="password" id="password" placeholder="Senha">
        <button id="login-button">Entrar</button>
    </div>
</div>

<div class="container">
    <h1>Gerenciamento de Imagens</h1>
    <div class="clock" id="clock">Carregando...</div>
    <h2>Vincular Agora</h2>
    <input type="file" id="fileElem" multiple accept="image/*">
    <div class="image-list" id="image-list"></div>
    <button onclick="scheduleImages()">Agendar Post</button>
    <button onclick="showHistory()">Histórico</button>
    <button onclick="deleteAllImages()">Apagar Todas as Imagens</button>
</div>

<!-- Bibliotecas -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
<script>
    // Configuração do Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAPcnUH5oj0krqEBcKFkRxg6h7GWiOiGWs",
        authDomain: "bc-berga.firebaseapp.com",
        projectId: "bc-berga",
        storageBucket: "bc-berga.firebasestorage.app",
        messagingSenderId: "955771763943",
        appId: "1:955771763943:web:b8e2b3c96dc7c8ddaaf642",
        measurementId: "G-1234T7JC84"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();
    const database = firebase.database();

    // Variáveis globais
    const USERNAME = "MarketingBergamini";
    const PASSWORD = "MarketingLoja010401@";
    const imageList = document.getElementById('image-list');
    let scheduledImages = [];

    // Função de Login
    function login() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();

        if (username === USERNAME && password === PASSWORD) {
            document.querySelector('.login-container').style.display = 'none';
            document.querySelector('.container').style.display = 'block';
            loadImages();
            startClock();
            startScheduledImageCheck();
        } else {
            alert('Usuário ou senha incorretos!');
        }
    }

    document.getElementById('login-button').addEventListener('click', login);

    // Função para iniciar o relógio
    function startClock() {
        const clockElement = document.getElementById('clock');
        setInterval(() => {
            const datetime = new Date();
            clockElement.textContent = `Relógio: ${datetime.toLocaleString()}`;
        }, 1000);
    }

    // Função para carregar imagens
    function loadImages() {
        const storageRef = storage.ref('images/');
        storageRef.listAll().then((res) => {
            res.items.forEach((itemRef) => {
                itemRef.getDownloadURL().then((url) => {
                    addImageToList(url, itemRef.name);
                }).catch((error) => {
                    console.error('Erro ao obter URL da imagem:', error);
                });
            });
        }).catch((error) => {
            console.error('Erro ao listar imagens:', error);
        });
    }

    // Função para adicionar imagens à lista
    function addImageToList(url, name) {
        const div = document.createElement('div');
        div.className = 'image-item';
        div.dataset.name = name;
        const img = document.createElement('img');
        img.src = url;
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = '&times;';
        deleteBtn.onclick = () => deleteImage(name);
        div.appendChild(img);
        div.appendChild(deleteBtn);
        imageList.appendChild(div);
    }

    // Função para excluir uma imagem
    function deleteImage(name) {
        if (!confirm('Tem certeza que deseja excluir esta imagem?')) return;

        const storageRef = storage.ref(`images/${name}`);
        storageRef.delete().then(() => {
            const div = document.querySelector(`.image-item[data-name="${name}"]`);
            if (div) div.remove();
            alert(`Imagem "${name}" excluída com sucesso!`);
        }).catch((error) => {
            console.error('Erro ao excluir imagem:', error);
            alert('Erro ao excluir imagem. Verifique o console para mais detalhes.');
        });
    }

    // Função para agendar imagens
    function scheduleImages() {
        const files = document.getElementById('fileElem').files;
        if (files.length === 0) {
            alert('Selecione pelo menos uma imagem para agendar.');
            return;
        }

        const startDate = prompt('Digite a data de início (YYYY-MM-DD):');
        const startTime = prompt('Digite a hora de início (HH:mm):');
        const endDate = prompt('Digite a data de término (YYYY-MM-DD):');
        const endTime = prompt('Digite a hora de término (HH:mm):');

        if (!startDate || !startTime || !endDate || !endTime) {
            alert('Preencha todos os campos de data e hora.');
            return;
        }

        const startDateTime = new Date(`${startDate}T${startTime}`);
        const endDateTime = new Date(`${endDate}T${endTime}`);

        if (startDateTime > endDateTime) {
            alert('A data/hora de início não pode ser maior que a data/hora de término.');
            return;
        }

        [...files].forEach(file => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const base64String = event.target.result.split(',')[1];
                const sanitizedKey = sanitizeFileName(file.name);

                // Salva no Firebase Realtime Database
                const scheduledRef = database.ref('scheduledImages/' + sanitizedKey);
                scheduledRef.set({
                    name: file.name,
                    startDateTime: startDateTime.toISOString(),
                    endDateTime: endDateTime.toISOString(),
                    base64: base64String
                }).then(() => {
                    alert(`Imagem "${file.name}" agendada com sucesso!`);
                }).catch((error) => {
                    console.error('Erro ao salvar agendamento:', error);
                });
            };
            reader.readAsDataURL(file);
        });
    }

    // Função para sanitizar nomes de arquivos
    function sanitizeFileName(name) {
        return name.replace(/[.#$[\]]/g, '_');
    }

    // Função para verificar imagens agendadas
    function checkScheduledImages() {
        const now = Date.now();
        const scheduledRef = database.ref('scheduledImages');
        scheduledRef.once('value').then((snapshot) => {
            const scheduledData = snapshot.val();
            if (!scheduledData) return;

            for (const [key, data] of Object.entries(scheduledData)) {
                const { name, startDateTime, endDateTime, base64 } = data;
                const startMs = new Date(startDateTime).getTime();
                const endMs = new Date(endDateTime).getTime();

                if (startMs <= now && endMs > now) {
                    // Vincula automaticamente
                    const imgSrc = `data:image/jpeg;base64,${base64}`;
                    addImageToList(imgSrc, name);
                }

                if (endMs <= now) {
                    // Remove automaticamente
                    deleteScheduledPost(key, name);
                }
            }
        }).catch((error) => {
            console.error('Erro ao verificar imagens agendadas:', error);
        });
    }

    // Função para remover um agendamento
    function deleteScheduledPost(key, name) {
        const scheduledRef = database.ref('scheduledImages/' + key);
        scheduledRef.remove().then(() => {
            const div = document.querySelector(`.image-item[data-name="${name}"]`);
            if (div) div.remove();
            alert(`Imagem "${name}" removida automaticamente após o término do período.`);
        }).catch((error) => {
            console.error('Erro ao remover agendamento:', error);
        });
    }

    // Função para iniciar a verificação automática
    function startScheduledImageCheck() {
        setInterval(checkScheduledImages, 60000); // Verifica a cada 1 minuto
    }

    // Função para mostrar o histórico
    function showHistory() {
        alert('Funcionalidade de histórico ainda em desenvolvimento.');
    }

    // Função para apagar todas as imagens
    function deleteAllImages() {
        if (!confirm('Tem certeza que deseja apagar todas as imagens?')) return;

        const storageRef = storage.ref('images/');
        storageRef.listAll().then((res) => {
            res.items.forEach((itemRef) => {
                itemRef.delete().catch((error) => {
                    console.error('Erro ao excluir imagem:', error);
                });
            });
        }).catch((error) => {
            console.error('Erro ao listar imagens:', error);
        });

        database.ref('scheduledImages').remove().then(() => {
            alert('Todas as imagens e agendamentos foram removidos.');
        }).catch((error) => {
            console.error('Erro ao limpar agendamentos:', error);
        });

        imageList.innerHTML = '';
    }
</script>
</body>
</html>
